<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acoustic Space Analyzer AI Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background: #0a0a0a;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }
        
        /* Custom styles for range inputs */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #ec4899;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            margin-top: -6px;
        }
        
        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
        }
        
        input[type="range"]::-moz-range-thumb {
            background: #ec4899;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: none;
        }
        
        /* EQ Slider styles */
        .eq-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 120px;
            background: transparent;
            outline: none;
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
            cursor: pointer;
        }
        
        .eq-slider::-webkit-slider-track {
            width: 8px;
            background: #374151;
            border-radius: 4px;
        }
        
        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 12px;
            background: #10b981;
            cursor: pointer;
            border-radius: 6px;
        }
        
        /* Animation for pulsing elements */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Animation for spinning elements */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Glow effect */
        .glow {
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(to right, #06b6d4, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;
        
        // Icon components
        const MicIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
        );
        
        const CameraIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
            </svg>
        );
        
        const BrainIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
                <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
            </svg>
        );
        
        const PlayIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="6 3 20 12 6 21 6 3"/>
            </svg>
        );
        
        const PauseIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="14" y="4" width="4" height="16" rx="1"/>
                <rect x="6" y="4" width="4" height="16" rx="1"/>
            </svg>
        );
        
        const SettingsIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );
        
        const DownloadIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );
        
        const RotateCcwIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
        );
        
        const KeyIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"/>
                <path d="m21 2-9.6 9.6"/>
                <circle cx="7.5" cy="15.5" r="5.5"/>
            </svg>
        );

        // Material database with Italian names
        const MATERIALS = {
            'cartongesso': { name: 'Cartongesso', absorption: { 125: 0.29, 250: 0.10, 500: 0.05, 1000: 0.04, 2000: 0.07, 4000: 0.09 }, color: '#e0e0e0' },
            'legno': { name: 'Legno massello', absorption: { 125: 0.15, 250: 0.11, 500: 0.10, 1000: 0.07, 2000: 0.06, 4000: 0.07 }, color: '#8b4513' },
            'vetro': { name: 'Vetro', absorption: { 125: 0.35, 250: 0.25, 500: 0.18, 1000: 0.12, 2000: 0.07, 4000: 0.04 }, color: '#87ceeb' },
            'cemento': { name: 'Cemento', absorption: { 125: 0.01, 250: 0.01, 500: 0.02, 1000: 0.02, 2000: 0.03, 4000: 0.03 }, color: '#808080' },
            'moquette': { name: 'Moquette', absorption: { 125: 0.08, 250: 0.24, 500: 0.57, 1000: 0.69, 2000: 0.71, 4000: 0.73 }, color: '#8b0000' },
            'tenda_pesante': { name: 'Tenda pesante', absorption: { 125: 0.14, 250: 0.35, 500: 0.55, 1000: 0.72, 2000: 0.70, 4000: 0.65 }, color: '#4b0082' },
            'pannello_fonoassorbente': { name: 'Pannello fonoassorbente', absorption: { 125: 0.20, 250: 0.65, 500: 0.85, 1000: 0.95, 2000: 0.95, 4000: 0.90 }, color: '#2f4f4f' },
            'intonaco': { name: 'Intonaco', absorption: { 125: 0.02, 250: 0.02, 500: 0.03, 1000: 0.04, 2000: 0.05, 4000: 0.05 }, color: '#f5f5dc' },
            'mattone': { name: 'Mattone', absorption: { 125: 0.03, 250: 0.03, 500: 0.03, 1000: 0.04, 2000: 0.05, 4000: 0.07 }, color: '#a52a2a' },
            'parquet': { name: 'Parquet', absorption: { 125: 0.04, 250: 0.04, 500: 0.07, 1000: 0.06, 2000: 0.06, 4000: 0.07 }, color: '#daa520' }
        };

        // 16-band frequencies for equalizer
        const EQ_FREQUENCIES = [20, 31.5, 63, 125, 250, 500, 1000, 2000, 3150, 4000, 5000, 6300, 8000, 10000, 12500, 16000];

        // DSP Processors for chain
        const DSP_PROCESSORS = {
            eq: { name: 'Equalizzatore Parametrico', params: ['frequency', 'gain', 'q'] },
            compressor: { name: 'Compressore', params: ['threshold', 'ratio', 'attack', 'release', 'knee'] },
            limiter: { name: 'Limiter', params: ['threshold', 'release', 'lookahead'] },
            gate: { name: 'Noise Gate', params: ['threshold', 'attack', 'hold', 'release'] },
            reverb: { name: 'Riverbero', params: ['roomSize', 'damping', 'wetLevel', 'dryLevel'] },
            delay: { name: 'Delay', params: ['time', 'feedback', 'mix'] },
            hpf: { name: 'Filtro Passa-Alto', params: ['frequency', 'q'] },
            lpf: { name: 'Filtro Passa-Basso', params: ['frequency', 'q'] }
        };

        const AcousticAnalyzerAI = () => {
            // State hooks
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [isScanning3D, setIsScanning3D] = useState(false);
            const [audioData, setAudioData] = useState(null);
            const [spatialData, setSpatialData] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [realTimeFFT, setRealTimeFFT] = useState([]);
            const [deviationData, setDeviationData] = useState([]);
            const [uploadedFile, setUploadedFile] = useState(null);
            const [microphoneStatus, setMicrophoneStatus] = useState('not-initialized');
            const [selectedMaterials, setSelectedMaterials] = useState({});
            const [surfaces, setSurfaces] = useState([]);
            const [apiConfig, setApiConfig] = useState({
                provider: 'openrouter',
                apiKey: '',
                model: 'deepseek/deepseek-r1-distill-llama-70b'
            });
            const [dspChain, setDspChain] = useState([]);
            const [eqSettings, setEqSettings] = useState(
                EQ_FREQUENCIES.reduce((acc, freq) => ({ ...acc, [freq]: 0 }), {})
            );
            
            // Refs
            const canvasRef = useRef(null);
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const microphoneRef = useRef(null);
            const animationRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const cameraRef = useRef(null);
            const recordingIntervalRef = useRef(null);
            
            // Pink noise reference spectrum (ideal response)
            const PINK_NOISE_REFERENCE = {
                20: 85, 31.5: 83, 63: 81, 125: 79, 250: 77, 500: 75,
                1000: 73, 2000: 71, 3150: 69, 4000: 68, 5000: 67,
                6300: 66, 8000: 65, 10000: 64, 12500: 63, 16000: 62
            };

            // Initialize on mount
            useEffect(() => {
                initialize3DVisualization();
                loadApiConfig();
                
                return () => {
                    if (animationRef.current) {
                        cancelAnimationFrame(animationRef.current);
                    }
                    if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
                        audioContextRef.current.close();
                    }
                    if (recordingIntervalRef.current) {
                        clearInterval(recordingIntervalRef.current);
                    }
                };
            }, []);

            // Load API config from localStorage
            const loadApiConfig = () => {
                const saved = localStorage.getItem('acousticAnalyzerApiConfig');
                if (saved) {
                    try {
                        setApiConfig(JSON.parse(saved));
                    } catch (e) {
                        console.error('Failed to load API config:', e);
                    }
                }
            };

            // Save API config to localStorage
            const saveApiConfig = (config) => {
                setApiConfig(config);
                localStorage.setItem('acousticAnalyzerApiConfig', JSON.stringify(config));
            };

            // Initialize audio system
            const initializeAudio = async () => {
                try {
                    setMicrophoneStatus('requesting');
                    
                    if (!audioContextRef.current) {
                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 48000,
                            latencyHint: 'interactive'
                        });
                    }
                    
                    if (audioContextRef.current.state === 'suspended') {
                        await audioContextRef.current.resume();
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 48000,
                            channelCount: 1
                        } 
                    });
                    
                    analyserRef.current = audioContextRef.current.createAnalyser();
                    analyserRef.current.fftSize = 16384; // High resolution FFT
                    analyserRef.current.smoothingTimeConstant = 0.1;
                    
                    microphoneRef.current = audioContextRef.current.createMediaStreamSource(stream);
                    microphoneRef.current.connect(analyserRef.current);
                    
                    setMicrophoneStatus('granted');
                    startRealTimeFFT();
                    
                    console.log('Audio system initialized');
                    
                } catch (error) {
                    console.error('Audio initialization error:', error);
                    setMicrophoneStatus('denied');
                    
                    if (error.name === 'NotAllowedError') {
                        alert('Permessi microfono negati. Clicca sull\'icona del microfono nella barra indirizzi e consenti l\'accesso.');
                    } else {
                        alert('Errore audio: ' + error.message);
                    }
                }
            };

            // Perform FFT analysis
            const performFFTAnalysis = () => {
                if (!analyserRef.current || !audioContextRef.current) return null;
                
                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const floatArray = new Float32Array(bufferLength);
                
                analyserRef.current.getByteFrequencyData(dataArray);
                analyserRef.current.getFloatFrequencyData(floatArray);
                
                const sampleRate = audioContextRef.current.sampleRate;
                const nyquist = sampleRate / 2;
                
                const frequencyData = EQ_FREQUENCIES.map(freq => {
                    const index = Math.round((freq / nyquist) * bufferLength);
                    const amplitude = dataArray[index] || 0;
                    const dbFS = floatArray[index] || -Infinity;
                    const dbSPL = dbFS + 94;
                    
                    // Calculate deviation from pink noise reference
                    const reference = PINK_NOISE_REFERENCE[freq] || 70;
                    const deviation = dbSPL - reference;
                    
                    return {
                        frequency: freq,
                        amplitude: amplitude,
                        dbFS: dbFS,
                        dbSPL: dbSPL,
                        deviation: deviation,
                        reference: reference
                    };
                });
                
                // Calculate overall metrics
                const rms = Math.sqrt(dataArray.reduce((sum, val) => sum + (val/255) * (val/255), 0) / bufferLength);
                const dbRMS = 20 * Math.log10(rms + 1e-10);
                const peakLevel = Math.max(...dataArray);
                const crestFactor = peakLevel / (rms * 255);
                
                return {
                    timestamp: Date.now(),
                    frequencyResponse: frequencyData,
                    rms: rms,
                    dbRMS: dbRMS,
                    peakLevel: peakLevel,
                    crestFactor: crestFactor
                };
            };

            // Start real-time FFT visualization
            const startRealTimeFFT = () => {
                if (!analyserRef.current) return;
                
                const updateFFT = () => {
                    if (microphoneStatus === 'granted') {
                        const analysis = performFFTAnalysis();
                        if (analysis) {
                            setRealTimeFFT(analysis.frequencyResponse);
                            setDeviationData(analysis.frequencyResponse.map(f => f.deviation));
                        }
                    }
                    animationRef.current = requestAnimationFrame(updateFFT);
                };
                updateFFT();
            };

            // Start recording
            const startRecording = async () => {
                if (microphoneStatus !== 'granted') {
                    await initializeAudio();
                    if (microphoneStatus !== 'granted') return;
                }
                
                setIsRecording(true);
                setRecordingTime(0);
                setAudioData([]);
                
                const startTime = Date.now();
                recordingIntervalRef.current = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    setRecordingTime(elapsed);
                    
                    const analysis = performFFTAnalysis();
                    if (analysis) {
                        setAudioData(prev => [...(prev || []), analysis]);
                    }
                    
                    if (elapsed >= 15) {
                        stopRecording();
                    }
                }, 100); // Sample every 100ms
            };

            // Stop recording
            const stopRecording = () => {
                if (recordingIntervalRef.current) {
                    clearInterval(recordingIntervalRef.current);
                    recordingIntervalRef.current = null;
                }
                setIsRecording(false);
                console.log('Recording completed');
            };

            // Initialize 3D visualization
            const initialize3DVisualization = () => {
                if (!canvasRef.current) return;
                
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0a0a0a);
                scene.fog = new THREE.Fog(0x0a0a0a, 10, 50);
                
                const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ 
                    canvas: canvasRef.current, 
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(400, 300);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.camera.near = 0.1;
                directionalLight.shadow.camera.far = 50;
                directionalLight.shadow.camera.left = -10;
                directionalLight.shadow.camera.right = 10;
                directionalLight.shadow.camera.top = 10;
                directionalLight.shadow.camera.bottom = -10;
                scene.add(directionalLight);
                
                // Grid
                const gridHelper = new THREE.GridHelper(20, 20, 0x333333, 0x333333);
                scene.add(gridHelper);
                
                camera.position.set(8, 6, 8);
                camera.lookAt(0, 0, 0);
                
                sceneRef.current = scene;
                rendererRef.current = renderer;
                cameraRef.current = camera;
                
                // Animation loop
                const animate = () => {
                    if (sceneRef.current && rendererRef.current && cameraRef.current) {
                        // Rotate camera around scene
                        const time = Date.now() * 0.0005;
                        cameraRef.current.position.x = Math.cos(time) * 10;
                        cameraRef.current.position.z = Math.sin(time) * 10;
                        cameraRef.current.lookAt(0, 0, 0);
                        
                        rendererRef.current.render(sceneRef.current, cameraRef.current);
                    }
                    requestAnimationFrame(animate);
                };
                animate();
            };

            // Handle file upload
            const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    setUploadedFile(file);
    setIsScanning3D(true);
    
    try {
        // Riconosci il file demo
        if (file.name.includes("DEMO_Empty_old_Garage_room.usdz")) {
            const spatialData = {
                source: "Demo Garage",
                fileName: file.name,
                roomDimensions: { 
                    width: 6.5,  // Modifica queste dimensioni secondo la realtà
                    height: 3.2, 
                    depth: 8.0 
                },
                volume: 166.4,  // width * height * depth
                surfaceArea: 180.8,  // 2*(wh + wd + hd)
                uploadedAt: new Date().toISOString(),
                treatments: [  // Aggiungi punti di trattamento acustico demo
                    { x: 2.1, y: 1.5, z: 1.8 },
                    { x: 4.3, y: 1.5, z: 6.2 }
                ]
            };
            setSpatialData(spatialData);
            generateSurfaces(spatialData.roomDimensions);
            visualize3DData(spatialData);
            setIsScanning3D(false);
            return;
        }
        
        if (file.name.toLowerCase().endsWith('.json')) {
            await processJSONFile(file);
        } else {
            await processGenericFile(file);
        }
    } catch (error) {
        console.error('File processing error:', error);
        alert('Errore nel caricamento: ' + error.message);
    }
    
    setIsScanning3D(false);
};




            return;
        }
        
        if (file.name.toLowerCase().endsWith('.json')) {
            await processJSONFile(file);
        } else {
            await processGenericFile(file);
        }
    } catch (error) {
        console.error('File processing error:', error);
        alert('Errore nel caricamento: ' + error.message);
    }
    
    setIsScanning3D(false);
};
            };

            // Process JSON file
            const processJSONFile = async (file) => {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.roomDimensions) {
                    throw new Error('File JSON deve contenere roomDimensions');
                }
                
                const spatialData = {
                    source: 'File JSON Custom',
                    fileName: file.name,
                    ...data,
                    uploadedAt: new Date().toISOString()
                };
                
                setSpatialData(spatialData);
                generateSurfaces(spatialData.roomDimensions);
                visualize3DData(spatialData);
            };

            // Process generic 3D file
            const processGenericFile = async (file) => {
                // Simulate extraction of room dimensions
                const dimensions = { 
                    width: 4.5 + Math.random() * 2, 
                    height: 2.8 + Math.random() * 0.4, 
                    depth: 5.5 + Math.random() * 2 
                };
                
                const spatialData = {
                    source: file.name.toLowerCase().endsWith('.usdz') ? 'iPhone LiDAR Scanner' : 'Scansione 3D',
                    fileName: file.name,
                    roomDimensions: dimensions,
                    volume: dimensions.width * dimensions.height * dimensions.depth,
                    surfaceArea: 2 * (dimensions.width * dimensions.height + 
                                     dimensions.width * dimensions.depth + 
                                     dimensions.height * dimensions.depth),
                    uploadedAt: new Date().toISOString()
                };
                
                setSpatialData(spatialData);
                generateSurfaces(dimensions);
                visualize3DData(spatialData);
            };

            // Generate surfaces from room dimensions
            const generateSurfaces = (dimensions) => {
                const { width, height, depth } = dimensions;
                const newSurfaces = [
                    { id: 'floor', name: 'Pavimento', area: width * depth, normal: [0, 1, 0] },
                    { id: 'ceiling', name: 'Soffitto', area: width * depth, normal: [0, -1, 0] },
                    { id: 'wall_front', name: 'Parete frontale', area: width * height, normal: [0, 0, -1] },
                    { id: 'wall_back', name: 'Parete posteriore', area: width * height, normal: [0, 0, 1] },
                    { id: 'wall_left', name: 'Parete sinistra', area: depth * height, normal: [1, 0, 0] },
                    { id: 'wall_right', name: 'Parete destra', area: depth * height, normal: [-1, 0, 0] }
                ];
                setSurfaces(newSurfaces);
            };

            // Visualize 3D data
            const visualize3DData = (data) => {
                if (!sceneRef.current) return;
                
                // Clear existing room
                const toRemove = [];
                sceneRef.current.traverse((child) => {
                    if (child.userData.isRoom) {
                        toRemove.push(child);
                    }
                });
                toRemove.forEach(child => sceneRef.current.remove(child));
                
                const { roomDimensions } = data;
                
                // Create room wireframe
                const roomGeometry = new THREE.BoxGeometry(
                    roomDimensions.width, 
                    roomDimensions.height, 
                    roomDimensions.depth
                );
                const roomMaterial = new THREE.MeshBasicMaterial({
                    color: 0x444444,
                    wireframe: true,
                    opacity: 0.3,
                    transparent: true
                });
                const room = new THREE.Mesh(roomGeometry, roomMaterial);
                room.userData.isRoom = true;
                sceneRef.current.add(room);
                
                // Add colored surfaces based on materials
                surfaces.forEach((surface, index) => {
                    const material = selectedMaterials[surface.id];
                    if (material) {
                        const mat = MATERIALS[material];
                        const surfaceMesh = createSurfaceMesh(surface, roomDimensions, mat.color);
                        surfaceMesh.userData.isRoom = true;
                        sceneRef.current.add(surfaceMesh);
                    }
                });
                
                // Add acoustic treatment indicators
                if (data.treatments) {
                    data.treatments.forEach(treatment => {
                        const geometry = new THREE.SphereGeometry(0.2);
                        const material = new THREE.MeshPhongMaterial({
                            color: 0x00ff00,
                            emissive: 0x00ff00,
                            emissiveIntensity: 0.5
                        });
                        const sphere = new THREE.Mesh(geometry, material);
                        sphere.position.set(treatment.x, treatment.y, treatment.z);
                        sphere.userData.isRoom = true;
                        sceneRef.current.add(sphere);
                    });
                }
            };

            // Create surface mesh
            const createSurfaceMesh = (surface, dimensions, color) => {
                let geometry;
                const material = new THREE.MeshPhongMaterial({
                    color: new THREE.Color(color),
                    opacity: 0.7,
                    transparent: true,
                    side: THREE.DoubleSide
                });
                
                const { width, height, depth } = dimensions;
                
                switch(surface.id) {
                    case 'floor':
                        geometry = new THREE.PlaneGeometry(width, depth);
                        const floorMesh = new THREE.Mesh(geometry, material);
                        floorMesh.rotation.x = -Math.PI / 2;
                        floorMesh.position.y = -height / 2;
                        return floorMesh;
                    
                    case 'ceiling':
                        geometry = new THREE.PlaneGeometry(width, depth);
                        const ceilingMesh = new THREE.Mesh(geometry, material);
                        ceilingMesh.rotation.x = Math.PI / 2;
                        ceilingMesh.position.y = height / 2;
                        return ceilingMesh;
                    
                    case 'wall_front':
                        geometry = new THREE.PlaneGeometry(width, height);
                        const frontMesh = new THREE.Mesh(geometry, material);
                        frontMesh.position.z = -depth / 2;
                        return frontMesh;
                    
                    case 'wall_back':
                        geometry = new THREE.PlaneGeometry(width, height);
                        const backMesh = new THREE.Mesh(geometry, material);
                        backMesh.rotation.y = Math.PI;
                        backMesh.position.z = depth / 2;
                        return backMesh;
                    
                    case 'wall_left':
                        geometry = new THREE.PlaneGeometry(depth, height);
                        const leftMesh = new THREE.Mesh(geometry, material);
                        leftMesh.rotation.y = Math.PI / 2;
                        leftMesh.position.x = -width / 2;
                        return leftMesh;
                    
                    case 'wall_right':
                        geometry = new THREE.PlaneGeometry(depth, height);
                        const rightMesh = new THREE.Mesh(geometry, material);
                        rightMesh.rotation.y = -Math.PI / 2;
                        rightMesh.position.x = width / 2;
                        return rightMesh;
                    
                    default:
                        return new THREE.Mesh();
                }
            };

            // Calculate room acoustics
            const calculateRoomAcoustics = () => {
                if (!spatialData || !surfaces.length) return null;
                
                const { volume, surfaceArea } = spatialData;
                const frequencyBands = [125, 250, 500, 1000, 2000, 4000];
                
                // Calculate total absorption for each frequency
                const absorption = frequencyBands.reduce((acc, freq) => {
                    let totalAbsorption = 0;
                    
                    surfaces.forEach(surface => {
                        const materialKey = selectedMaterials[surface.id];
                        if (materialKey && MATERIALS[materialKey]) {
                            const material = MATERIALS[materialKey];
                            totalAbsorption += surface.area * (material.absorption[freq] || 0.05);
                        }
                    });
                    
                    acc[freq] = totalAbsorption;
                    return acc;
                }, {});
                
                // Calculate RT60 using Sabine equation
                const rt60 = frequencyBands.reduce((acc, freq) => {
                    const A = absorption[freq];
                    if (A > 0) {
                        acc[freq] = (0.161 * volume) / A;
                    } else {
                        acc[freq] = 10; // Default high value
                    }
                    return acc;
                }, {});
                
                // Calculate average RT60
                const avgRT60 = Object.values(rt60).reduce((a, b) => a + b, 0) / frequencyBands.length;
                
                return {
                    absorption,
                    rt60,
                    avgRT60,
                    volume,
                    surfaceArea
                };
            };

            // Analyze with AI
            const analyzeWithAI = async () => {
                if (!audioData || !spatialData) {
                    alert('Effettua prima la registrazione audio e la scansione 3D!');
                    return;
                }
                
                if (!apiConfig.apiKey) {
                    alert('Configura prima la chiave API!');
                    return;
                }
                
                setIsAnalyzing(true);
                
                try {
                    // Calculate room acoustics
                    const acoustics = calculateRoomAcoustics();
                    
                    // Prepare audio analysis
                    const avgFrequencyResponse = {};
                    EQ_FREQUENCIES.forEach(freq => {
                        const values = audioData.map(d => 
                            d.frequencyResponse.find(f => f.frequency === freq)?.dbSPL || 0
                        );
                        avgFrequencyResponse[freq] = values.reduce((a, b) => a + b, 0) / values.length;
                    });
                    
                    // Prepare prompt
                    const prompt = `Sei un esperto ingegnere del suono specializzato in DSP e correzione acustica SOFTWARE. Analizza questi dati e fornisci una catena di processamento DSP ottimale.

IMPORTANTE: L'utente può usare SOLO soluzioni software/DSP. NON suggerire trattamenti fisici come pannelli, bass trap, tappeti, etc.

DATI AUDIO (Pink Noise Response):
${JSON.stringify(avgFrequencyResponse, null, 2)}

DATI SPAZIALI:
- Volume: ${spatialData.volume.toFixed(1)}m³
- Dimensioni: ${spatialData.roomDimensions.width.toFixed(1)}x${spatialData.roomDimensions.height.toFixed(1)}x${spatialData.roomDimensions.depth.toFixed(1)}m
- RT60 per banda: ${acoustics ? JSON.stringify(acoustics.rt60, null, 2) : 'Non calcolato'}

MATERIALI SUPERFICI:
${surfaces.map(s => `${s.name}: ${MATERIALS[selectedMaterials[s.id]]?.name || 'Non assegnato'}`).join('\n')}

Rispondi SOLO con un JSON valido contenente:
{
  "dspChain": [
    {
      "type": "eq|compressor|limiter|gate|reverb|delay|hpf|lpf",
      "params": {
        // parametri specifici per tipo
      },
      "description": "breve descrizione tecnica"
    }
  ],
  "eqCurve": {
    "20": 0, "31.5": 0, "63": 0, "125": 0, "250": 0, "500": 0, 
    "1000": 0, "2000": 0, "3150": 0, "4000": 0, "5000": 0, 
    "6300": 0, "8000": 0, "10000": 0, "12500": 0, "16000": 0
  },
  "problemi": ["lista problemi acustici identificati"],
  "score": 7.5, // score qualità 1-10
  "suggerimenti": ["SOLO suggerimenti SOFTWARE: plugin VST, tecniche DSP, room correction software, etc"]
}`;

                    // Make API call
                    const response = await callAI(prompt);
                    
                    if (response) {
                        setAiAnalysis(response);
                        if (response.dspChain) {
                            setDspChain(response.dspChain);
                        }
                        if (response.eqCurve) {
                            setEqSettings(response.eqCurve);
                        }
                    }
                    
                } catch (error) {
                    console.error('AI analysis error:', error);
                    // Fallback to local analysis
                    performLocalAnalysis();
                }
                
                setIsAnalyzing(false);
            };

            // Call AI API
            const callAI = async (prompt) => {
                const { provider, apiKey, model } = apiConfig;
                
                try {
                    let response;
                    
                    if (provider === 'openrouter') {
                        response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.href,
                                'X-Title': 'Acoustic Analyzer AI'
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'user', content: prompt }],
                                temperature: 0.3,
                                max_tokens: 2000
                            })
                        });
                    } else if (provider === 'groq') {
                        response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'llama-3.3-70b-versatile',
                                messages: [{ role: 'user', content: prompt }],
                                temperature: 0.3,
                                max_tokens: 2000
                            })
                        });
                    }
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    
                    // Parse JSON from response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    
                    throw new Error('Invalid JSON response');
                    
                } catch (error) {
                    console.error('AI API error:', error);
                    throw error;
                }
            };

            // Perform local analysis (fallback)
            const performLocalAnalysis = () => {
                const acoustics = calculateRoomAcoustics();
                const avgRT60 = acoustics?.avgRT60 || 0.5;
                
                // Generate EQ curve based on deviations
                const eqCurve = {};
                EQ_FREQUENCIES.forEach(freq => {
                    const deviation = deviationData[EQ_FREQUENCIES.indexOf(freq)] || 0;
                    eqCurve[freq] = Math.round(-deviation * 0.7 * 10) / 10; // 70% correction
                });
                
                // Generate DSP chain - Start with EQ for sub frequencies
                const dspChain = [
                    {
                        type: 'eq',
                        params: { frequency: 31.5, gain: eqCurve[31.5] || -2, q: 1.5 },
                        description: 'Correzione sub-bass (mantiene contenuto sub)'
                    },
                    {
                        type: 'eq',
                        params: { frequency: 63, gain: eqCurve[63] || -2.5, q: 1.8 },
                        description: 'Controllo risonanze profonde'
                    },
                    {
                        type: 'eq',
                        params: { frequency: 125, gain: eqCurve[125] || -3, q: 2 },
                        description: 'Correzione risonanza modale principale'
                    },
                    {
                        type: 'eq',
                        params: { frequency: 250, gain: eqCurve[250] || -2, q: 1.5 },
                        description: 'Bilanciamento medio-bassi'
                    }
                ];
                
                // Add HPF only if really needed (for very problematic rooms)
                if (avgRT60 > 0.8 && eqCurve[20] < -6) {
                    dspChain.push({
                        type: 'hpf',
                        params: { frequency: 25, q: 0.5 },
                        description: 'Rimuove solo infrasuoni estremi (preserva sub)'
                    });
                }
                
                dspChain.push({
                    type: 'compressor',
                    params: { threshold: -12, ratio: 3, attack: 10, release: 100, knee: 2 },
                    description: 'Controllo dinamica generale'
                });
                
                if (avgRT60 > 0.6) {
                    dspChain.push({
                        type: 'reverb',
                        params: { roomSize: 0.3, damping: 0.8, wetLevel: -20, dryLevel: 0 },
                        description: 'Compensazione riverbero eccessivo'
                    });
                }
                
                const analysis = {
                    dspChain,
                    eqCurve,
                    problemi: [
                        avgRT60 > 0.6 ? 'Tempo di riverbero eccessivo' : 'Riverbero nella norma',
                        'Possibili risonanze modali a basse frequenze',
                        'Riflessioni primarie non compensate via DSP'
                    ],
                    score: Math.max(1, Math.min(10, 10 - avgRT60 * 3)),
                    suggerimenti: [
                        'Usa EQ dinamico multibanda per controllo adattivo delle risonanze',
                        'Applica un De-esser alle frequenze 4-8kHz se sibilanti eccessive',
                        'Configura crossover digitale per gestione ottimale dei sub',
                        avgRT60 > 0.7 ? 'Usa plugin di de-riverbero come SPL De-Verb o Zynaptiq UNVEIL' : 'Bilancia EQ lineare e dinamico',
                        'Implementa room correction software (Sonarworks, IK ARC, Dirac Live)',
                        'Usa compressore multibanda per controllo zonale dello spettro',
                        'Applica slight stereo widening sopra 300Hz per maggiore spazialità'
                    ]
                };
                
                setAiAnalysis(analysis);
                setDspChain(analysis.dspChain);
                setEqSettings(eqCurve);
            };

            // Export results
            const exportResults = () => {
                if (!aiAnalysis) return;
                
                const exportData = {
                    timestamp: new Date().toISOString(),
                    audioData: {
                        samples: audioData.length,
                        duration: '15 seconds',
                        sampleRate: 48000,
                        fftSize: 16384
                    },
                    spatialData,
                    materials: surfaces.map(s => ({
                        surface: s.name,
                        material: MATERIALS[selectedMaterials[s.id]]?.name || 'Non assegnato',
                        area: s.area
                    })),
                    acoustics: calculateRoomAcoustics(),
                    aiAnalysis,
                    dspChain,
                    eqSettings
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `acoustic-analysis-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // Reset analysis
            const resetAnalysis = () => {
                setAudioData(null);
                setSpatialData(null);
                setAiAnalysis(null);
                setDspChain([]);
                setEqSettings(EQ_FREQUENCIES.reduce((acc, freq) => ({ ...acc, [freq]: 0 }), {}));
                setMicrophoneStatus('not-initialized');
                setUploadedFile(null);
                setRealTimeFFT([]);
                setDeviationData([]);
                setSelectedMaterials({});
                setSurfaces([]);
                setRecordingTime(0);
                
                const fileInput = document.getElementById('file-upload');
                if (fileInput) {
                    fileInput.value = '';
                }
                
                if (sceneRef.current) {
                    const toRemove = [];
                    sceneRef.current.traverse((child) => {
                        if (child.userData.isRoom) {
                            toRemove.push(child);
                        }
                    });
                    toRemove.forEach(child => sceneRef.current.remove(child));
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-white">
                    <div className="container mx-auto p-6 max-w-7xl">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-bold mb-2 gradient-text">
                                Acoustic Space Analyzer AI Pro
                            </h1>
                            <p className="text-gray-300 text-lg">Analisi acustica professionale con DSP Chain Generator</p>
                        </div>

                        {/* API Configuration */}
                        <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 mb-8 border border-gray-700">
                            <h3 className="text-xl font-semibold mb-4 flex items-center">
                                <KeyIcon className="mr-2 text-yellow-400" />
                                Configurazione API AI
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-400 mb-1">Provider</label>
                                    <select
                                        value={apiConfig.provider}
                                        onChange={(e) => saveApiConfig({ ...apiConfig, provider: e.target.value })}
                                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500"
                                    >
                                        <option value="openrouter">OpenRouter</option>
                                        <option value="groq">Groq</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-400 mb-1">API Key</label>
                                    <input
                                        type="password"
                                        value={apiConfig.apiKey}
                                        onChange={(e) => saveApiConfig({ ...apiConfig, apiKey: e.target.value })}
                                        placeholder="sk-or-v1-..."
                                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-400 mb-1">Modello</label>
                                    <select
                                        value={apiConfig.model}
                                        onChange={(e) => saveApiConfig({ ...apiConfig, model: e.target.value })}
                                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500"
                                    >
                                        {apiConfig.provider === 'openrouter' ? (
                                            <>
                                                <option value="deepseek/deepseek-r1-distill-llama-70b">DeepSeek R1 70B</option>
                                                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                                                <option value="google/gemini-flash-1.5">Gemini Flash 1.5</option>
                                            </>
                                        ) : (
                                            <>
                                                <option value="llama-3.3-70b-versatile">Llama 3.3 70B</option>
                                                <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                                            </>
                                        )}
                                    </select>
                                </div>
                            </div>
                            <div className="mt-2 text-xs text-gray-400">
                                {apiConfig.provider === 'openrouter' ? (
                                    <span>Ottieni API key gratuita su <a href="https://openrouter.ai" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">openrouter.ai</a></span>
                                ) : (
                                    <span>Ottieni API key gratuita su <a href="https://console.groq.com" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">console.groq.com</a></span>
                                )}
                            </div>
                        </div>

                        {/* Main Controls */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            {/* Audio Recording */}
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4 flex items-center">
                                    <MicIcon className="mr-2 text-cyan-400" />
                                    Registrazione Audio
                                </h3>
                                
                                <div className="mb-4">
                                    <div className={`text-center py-2 px-3 rounded-lg ${
                                        microphoneStatus === 'not-initialized' ? 'bg-gray-700 text-gray-300' :
                                        microphoneStatus === 'requesting' ? 'bg-yellow-900/30 text-yellow-400' :
                                        microphoneStatus === 'denied' ? 'bg-red-900/30 text-red-400' :
                                        'bg-green-900/30 text-green-400'
                                    }`}>
                                        {microphoneStatus === 'not-initialized' && '⚪ Sistema non inizializzato'}
                                        {microphoneStatus === 'requesting' && '⏳ Richiedendo permessi...'}
                                        {microphoneStatus === 'denied' && '❌ Permessi negati'}
                                        {microphoneStatus === 'granted' && '✅ Microfono attivo'}
                                    </div>
                                </div>
                                
                                <button
                                    onClick={microphoneStatus !== 'granted' ? initializeAudio : (isRecording ? stopRecording : startRecording)}
                                    disabled={microphoneStatus === 'requesting'}
                                    className={`w-full py-3 px-4 rounded-lg font-medium transition-all ${
                                        microphoneStatus !== 'granted'
                                            ? 'bg-blue-600 hover:bg-blue-700'
                                            : isRecording
                                            ? 'bg-red-600 hover:bg-red-700'
                                            : 'bg-cyan-600 hover:bg-cyan-700'
                                    } active:scale-95`}
                                >
                                    {microphoneStatus !== 'granted' ? (
                                        <div className="flex items-center justify-center">
                                            <MicIcon className="mr-2" />
                                            Inizializza Microfono
                                        </div>
                                    ) : isRecording ? (
                                        <div className="flex items-center justify-center">
                                            <PauseIcon className="mr-2" />
                                            Stop ({(15 - recordingTime).toFixed(1)}s)
                                        </div>
                                    ) : (
                                        <div className="flex items-center justify-center">
                                            <PlayIcon className="mr-2" />
                                            Registra Pink Noise (15s)
                                        </div>
                                    )}
                                </button>
                                
                                {audioData && (
                                    <div className="mt-3 text-sm text-green-400">
                                        ✓ {audioData.length} campioni acquisiti
                                    </div>
                                )}
                                
                                {isRecording && (
                                    <div className="mt-3">
                                        <div className="bg-gray-700 rounded-full h-2 overflow-hidden">
                                            <div 
                                                className="bg-cyan-500 h-full transition-all duration-100"
                                                style={{ width: `${(recordingTime / 15) * 100}%` }}
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* 3D File Upload */}


                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
    <h3 className="text-xl font-semibold mb-4 flex items-center">
        <CameraIcon className="mr-2 text-purple-400" />
        Scansione 3D
    </h3>
    <div className="flex flex-col gap-2">
        <input
            type="file"
            id="file-upload"
            className="hidden"
        />
        <label
            htmlFor="file-upload"
            className="w-full py-3 px-4 rounded-lg font-medium transition-all cursor-pointer border-2 border-dashed flex items-center justify-center bg-purple-600/20 border-purple-400 hover:bg-purple-600/30 active:scale-95"
        >
            <CameraIcon className="mr-2" />
            Carica Scansione
        </label>
        
        {/* Pulsante Demo */}
        <button
            onClick={() => {
                // Simula il caricamento del file demo
                const demoFile = new File([""], "DEMO_Empty_old_Garage_room.usdz");
                handleFileUpload({ target: { files: [demoFile] } });
            }}
            className="w-full py-3 px-4 rounded-lg font-medium bg-blue-600/20 border border-blue-400 hover:bg-blue-600/30 transition-all"
        >
            🏚️ Carica Demo Garage
        </button>
    </div>
</div>


                                    )}
                                </label>
                                
                                <div className="mt-2 text-xs text-gray-400 text-center">
                                    .usdz (iPhone) • .ply • .obj • .json
                                </div>
                                
                                {spatialData && (
                                    <div className="mt-3 text-sm text-green-400">
                                        ✓ {spatialData.roomDimensions.width.toFixed(1)}×{spatialData.roomDimensions.height.toFixed(1)}×{spatialData.roomDimensions.depth.toFixed(1)}m
                                        <div className="text-xs text-gray-400">{uploadedFile?.name}</div>
                                    </div>
                                )}
                            </div>

                            {/* AI Analysis */}
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4 flex items-center">
                                    <BrainIcon className="mr-2 text-pink-400" />
                                    Analisi AI
                                </h3>
                                <button
                                    onClick={analyzeWithAI}
                                    disabled={isAnalyzing || !audioData || !spatialData || !apiConfig.apiKey}
                                    className={`w-full py-3 px-4 rounded-lg font-medium transition-all ${
                                        isAnalyzing || !audioData || !spatialData || !apiConfig.apiKey
                                            ? 'bg-gray-600 cursor-not-allowed'
                                            : 'bg-pink-600 hover:bg-pink-700 active:scale-95'
                                    }`}
                                >
                                    {isAnalyzing ? (
                                        <div className="flex items-center justify-center">
                                            <BrainIcon className="animate-pulse mr-2" />
                                            Analizzando...
                                        </div>
                                    ) : (
                                        <div className="flex items-center justify-center">
                                            <BrainIcon className="mr-2" />
                                            Genera DSP Chain
                                        </div>
                                    )}
                                </button>
                                
                                {!apiConfig.apiKey && (
                                    <p className="text-xs text-red-400 mt-2 text-center">
                                        ⚠️ Configura API key
                                    </p>
                                )}
                                
                                {aiAnalysis && (
                                    <p className="text-sm text-green-400 mt-3">
                                        ✓ Score: {aiAnalysis.score}/10
                                    </p>
                                )}
                            </div>
                        </div>

                        {/* Real-time FFT Visualization */}
                        {microphoneStatus === 'granted' && (
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 mb-8 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4">Analisi Spettrale Real-Time</h3>
                                <div className="grid grid-cols-8 md:grid-cols-16 gap-1">
                                    {realTimeFFT.map((freq, index) => (
                                        <div key={index} className="text-center">
                                            <div className="text-xs text-gray-400 mb-1 transform -rotate-45 origin-bottom-left">
                                                {freq.frequency >= 1000 ? `${freq.frequency/1000}k` : freq.frequency}
                                            </div>
                                            <div className="bg-gray-700 rounded h-32 relative overflow-hidden">
                                                {/* Reference line */}
                                                <div 
                                                    className="absolute w-full border-t border-yellow-500 opacity-50"
                                                    style={{ bottom: `${(freq.reference / 100) * 100}%` }}
                                                />
                                                {/* Actual level */}
                                                <div 
                                                    className={`absolute bottom-0 w-full transition-all duration-75 ${
                                                        freq.deviation > 3 ? 'bg-red-500' :
                                                        freq.deviation < -3 ? 'bg-blue-500' :
                                                        'bg-green-500'
                                                    }`}
                                                    style={{ 
                                                        height: `${Math.max(0, Math.min(100, (freq.dbSPL / 100) * 100))}%` 
                                                    }}
                                                />
                                            </div>
                                            <div className={`text-xs mt-1 ${
                                                Math.abs(freq.deviation) > 3 ? 'text-yellow-400' : 'text-gray-400'
                                            }`}>
                                                {freq.deviation > 0 ? '+' : ''}{freq.deviation.toFixed(1)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 flex items-center justify-center space-x-8 text-sm">
                                    <div className="flex items-center">
                                        <div className="w-4 h-4 bg-yellow-500 mr-2"></div>
                                        <span className="text-gray-400">Riferimento Pink Noise</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-4 h-4 bg-green-500 mr-2"></div>
                                        <span className="text-gray-400">Risposta OK (±3dB)</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-4 h-4 bg-red-500 mr-2"></div>
                                        <span className="text-gray-400">Eccesso</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-4 h-4 bg-blue-500 mr-2"></div>
                                        <span className="text-gray-400">Carenza</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Material Assignment */}
                        {surfaces.length > 0 && (
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 mb-8 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4">Assegnazione Materiali</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {surfaces.map(surface => (
                                        <div key={surface.id} className="bg-gray-700/50 p-4 rounded-lg">
                                            <h4 className="font-medium mb-2">{surface.name}</h4>
                                            <p className="text-sm text-gray-400 mb-2">Area: {surface.area.toFixed(1)} m²</p>
                                            <select
                                                value={selectedMaterials[surface.id] || ''}
                                                onChange={(e) => {
                                                    setSelectedMaterials({
                                                        ...selectedMaterials,
                                                        [surface.id]: e.target.value
                                                    });
                                                    // Update 3D visualization
                                                    if (spatialData) {
                                                        visualize3DData(spatialData);
                                                    }
                                                }}
                                                className="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded focus:outline-none focus:border-purple-500"
                                            >
                                                <option value="">Seleziona materiale...</option>
                                                {Object.entries(MATERIALS).map(([key, mat]) => (
                                                    <option key={key} value={key}>{mat.name}</option>
                                                ))}
                                            </select>
                                            {selectedMaterials[surface.id] && (
                                                <div 
                                                    className="mt-2 h-3 rounded"
                                                    style={{ backgroundColor: MATERIALS[selectedMaterials[surface.id]].color }}
                                                />
                                            )}
                                        </div>
                                    ))}
                                </div>
                                {calculateRoomAcoustics() && (
                                    <div className="mt-4 p-4 bg-gray-700/30 rounded-lg">
                                        <p className="text-sm">
                                            <span className="text-gray-400">RT60 medio stimato:</span>{' '}
                                            <span className="text-lg font-semibold text-cyan-400">
                                                {calculateRoomAcoustics().avgRT60.toFixed(2)}s
                                            </span>
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 3D Visualization and EQ */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            {/* 3D View */}
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4">Visualizzazione 3D</h3>
                                <div className="flex justify-center">
                                    <canvas ref={canvasRef} className="border border-gray-600 rounded-lg" />
                                </div>
                                {spatialData && (
                                    <div className="mt-4 grid grid-cols-3 gap-4 text-sm">
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-blue-400">
                                                {spatialData.volume.toFixed(1)}
                                            </div>
                                            <div className="text-gray-400">m³ Volume</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-purple-400">
                                                {spatialData.surfaceArea.toFixed(1)}
                                            </div>
                                            <div className="text-gray-400">m² Superficie</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-green-400">
                                                {(spatialData.volume / spatialData.surfaceArea).toFixed(2)}
                                            </div>
                                            <div className="text-gray-400">Rapporto V/S</div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* 16-band EQ */}
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4">Equalizzatore 16 Bande</h3>
                                <div className="flex items-end justify-between h-48 px-4">
                                    {EQ_FREQUENCIES.map((freq, index) => (
                                        <div key={freq} className="flex flex-col items-center">
                                            <div className="relative h-32 flex items-center">
                                                <input
                                                    type="range"
                                                    min="-12"
                                                    max="12"
                                                    step="0.5"
                                                    value={eqSettings[freq] || 0}
                                                    onChange={(e) => setEqSettings({
                                                        ...eqSettings,
                                                        [freq]: parseFloat(e.target.value)
                                                    })}
                                                    className="eq-slider"
                                                    style={{
                                                        transform: 'rotate(-90deg)',
                                                        transformOrigin: 'center',
                                                        width: '120px',
                                                        marginLeft: '-46px',
                                                        marginRight: '-46px'
                                                    }}
                                                />
                                            </div>
                                            <div className="text-xs text-gray-400 mt-2 transform -rotate-45 origin-top-left">
                                                {freq >= 1000 ? `${freq/1000}k` : freq}
                                            </div>
                                            <div className={`text-xs mt-1 ${
                                                eqSettings[freq] > 0 ? 'text-green-400' : 
                                                eqSettings[freq] < 0 ? 'text-red-400' : 
                                                'text-gray-400'
                                            }`}>
                                                {eqSettings[freq] > 0 ? '+' : ''}{eqSettings[freq]}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 flex justify-center space-x-4">
                                    <button
                                        onClick={() => setEqSettings(
                                            EQ_FREQUENCIES.reduce((acc, freq) => ({ ...acc, [freq]: 0 }), {})
                                        )}
                                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded transition-all"
                                    >
                                        Reset
                                    </button>
                                    {aiAnalysis?.eqCurve && (
                                        <button
                                            onClick={() => {
                                                // Create new settings object with all frequencies
                                                const newSettings = {};
                                                EQ_FREQUENCIES.forEach(freq => {
                                                    // Use AI value if available, otherwise keep current value or default to 0
                                                    newSettings[freq] = aiAnalysis.eqCurve[freq] !== undefined 
                                                        ? aiAnalysis.eqCurve[freq] 
                                                        : (eqSettings[freq] || 0);
                                                });
                                                console.log('Applying AI EQ:', newSettings);
                                                setEqSettings(newSettings);
                                            }}
                                            className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded transition-all"
                                        >
                                            Applica AI
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* DSP Chain Display */}
                        {dspChain.length > 0 && (
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 mb-8 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4">Catena DSP Consigliata</h3>
                                <div className="bg-gray-900/50 p-6 rounded-lg border border-gray-600">
                                    <div className="flex items-center justify-between overflow-x-auto pb-4">
                                        {dspChain.map((processor, index) => (
                                            <React.Fragment key={index}>
                                                <div className="flex-shrink-0">
                                                    <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg p-4 min-w-[200px] transform hover:scale-105 transition-transform cursor-pointer">
                                                        <div className="text-center mb-2">
                                                            <div className="text-lg font-bold text-white">
                                                                {DSP_PROCESSORS[processor.type]?.name || processor.type}
                                                            </div>
                                                            <div className="text-xs text-gray-200 opacity-80">
                                                                {processor.type.toUpperCase()}
                                                            </div>
                                                        </div>
                                                        <div className="space-y-1 mt-3">
                                                            {Object.entries(processor.params).slice(0, 3).map(([param, value]) => (
                                                                <div key={param} className="flex justify-between text-xs">
                                                                    <span className="text-gray-200">{param}:</span>
                                                                    <span className="font-mono text-yellow-300">
                                                                        {typeof value === 'number' ? value.toFixed(1) : value}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-gray-400 text-center mt-2 max-w-[200px]">
                                                        {processor.description}
                                                    </div>
                                                </div>
                                                {index < dspChain.length - 1 && (
                                                    <div className="flex-shrink-0 px-4">
                                                        <svg width="40" height="40" viewBox="0 0 40 40">
                                                            <defs>
                                                                <marker
                                                                    id="arrowhead"
                                                                    markerWidth="10"
                                                                    markerHeight="7"
                                                                    refX="9"
                                                                    refY="3.5"
                                                                    orient="auto"
                                                                >
                                                                    <polygon
                                                                        points="0 0, 10 3.5, 0 7"
                                                                        fill="#9333ea"
                                                                    />
                                                                </marker>
                                                            </defs>
                                                            <line
                                                                x1="5"
                                                                y1="20"
                                                                x2="35"
                                                                y2="20"
                                                                stroke="#9333ea"
                                                                strokeWidth="3"
                                                                markerEnd="url(#arrowhead)"
                                                            />
                                                        </svg>
                                                    </div>
                                                )}
                                            </React.Fragment>
                                        ))}
                                    </div>
                                    <div className="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-gray-800 p-3 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-cyan-400">{dspChain.length}</div>
                                            <div className="text-xs text-gray-400">Processori</div>
                                        </div>
                                        <div className="bg-gray-800 p-3 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-green-400">
                                                {dspChain.filter(p => p.type === 'eq').length}
                                            </div>
                                            <div className="text-xs text-gray-400">Bande EQ</div>
                                        </div>
                                        <div className="bg-gray-800 p-3 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-purple-400">
                                                {dspChain.find(p => p.type === 'hpf')?.params.frequency || 'N/A'}
                                            </div>
                                            <div className="text-xs text-gray-400">HPF (Hz)</div>
                                        </div>
                                        <div className="bg-gray-800 p-3 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-yellow-400">
                                                {aiAnalysis?.score || 'N/A'}
                                            </div>
                                            <div className="text-xs text-gray-400">Score</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* AI Analysis Results */}
                        {aiAnalysis && (
                            <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 mb-8 border border-gray-700">
                                <h3 className="text-xl font-semibold mb-4">Risultati Analisi AI</h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div className="bg-gradient-to-r from-green-900/30 to-green-800/30 p-4 rounded-lg border border-green-700/30">
                                        <div className="text-3xl font-bold text-green-400">
                                            {aiAnalysis.score}/10
                                        </div>
                                        <div className="text-sm text-gray-300">Score Qualità</div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-blue-900/30 to-blue-800/30 p-4 rounded-lg border border-blue-700/30">
                                        <div className="text-3xl font-bold text-blue-400">
                                            {calculateRoomAcoustics()?.avgRT60.toFixed(2)}s
                                        </div>
                                        <div className="text-sm text-gray-300">RT60 Medio</div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-purple-900/30 to-purple-800/30 p-4 rounded-lg border border-purple-700/30">
                                        <div className="text-3xl font-bold text-purple-400">
                                            {dspChain.length}
                                        </div>
                                        <div className="text-sm text-gray-300">Processori DSP</div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-cyan-900/30 to-cyan-800/30 p-4 rounded-lg border border-cyan-700/30">
                                        <div className="text-3xl font-bold text-cyan-400">
                                            {surfaces.filter(s => selectedMaterials[s.id]).length}
                                        </div>
                                        <div className="text-sm text-gray-300">Superfici Trattate</div>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 className="font-semibold text-red-400 mb-2">Problemi Identificati:</h4>
                                        <ul className="space-y-1 text-sm">
                                            {aiAnalysis.problemi?.map((problema, index) => (
                                                <li key={index} className="text-gray-300 flex items-start">
                                                    <span className="text-red-400 mr-2">•</span>
                                                    {problema}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold text-green-400 mb-2">Suggerimenti:</h4>
                                        <ul className="space-y-1 text-sm">
                                            {aiAnalysis.suggerimenti?.map((suggerimento, index) => (
                                                <li key={index} className="text-gray-300 flex items-start">
                                                    <span className="text-green-400 mr-2">•</span>
                                                    {suggerimento}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Export and Reset */}
                        <div className="flex flex-col sm:flex-row gap-4 justify-center">
                            <button
                                onClick={exportResults}
                                disabled={!aiAnalysis}
                                className={`py-3 px-6 rounded-lg font-medium transition-all ${
                                    !aiAnalysis
                                        ? 'bg-gray-600 cursor-not-allowed'
                                        : 'bg-green-600 hover:bg-green-700 active:scale-95'
                                }`}
                            >
                                <DownloadIcon className="inline mr-2" />
                                Esporta JSON
                            </button>
                            <button
                                onClick={resetAnalysis}
                                className="py-3 px-6 rounded-lg font-medium bg-gray-600 hover:bg-gray-700 transition-all active:scale-95"
                            >
                                <RotateCcwIcon className="inline mr-2" />
                                Reset Completo
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<AcousticAnalyzerAI />, document.getElementById('root'));
    </script>
</body>
</html>
